<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>send ç…§æ˜çŠ¶æ³</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
  body { font-family: monospace; background: #222; color: #ddd; padding: 20px; text-align: center; }
  h1 { color: #fff; border-bottom: 1px solid #444; padding-bottom: 15px; }
  #main { max-width: 800px; margin: auto; }
  #output { 
    background: #000; color: #0f0; 
    padding: 15px; height: 350px; 
    overflow-y: scroll; 
    border: 1px solid #444; border-radius: 5px; 
    text-align: left; font-size: 13px;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
  }
  button { 
    padding: 15px 30px; font-size: 18px; cursor: pointer; 
    background: #E65100; color: white; border: none; border-radius: 5px; 
    font-weight: bold; margin-bottom: 20px; transition: 0.3s;
  }
  button:hover { background: #EF6C00; }
  button:disabled { background: #555; cursor: default; }
  .log-ts { color: #888; margin-right: 10px; }
  .log-val { color: #0ff; font-weight: bold; }
  .log-err { color: #f44336; }
</style>
</head>
<body>

<div id="main">
  <h1>send ç…§æ˜çŠ¶æ³</h1>
  <button id="connectBtn">ğŸ”Œ Connect micro:bit</button>
  <div id="output">Click "Connect" to start...<br>(Array[0] will be ignored)</div>
</div>

<script>
// Firebaseè¨­å®š
const firebaseConfig = {
  apiKey: "AIzaSyAt9FoenejYFhDIDZg5BTYfcl0x-czJ4v4",
  authDomain: "server-f5ca2.firebaseapp.com",
  databaseURL: "https://server-f5ca2-default-rtdb.firebaseio.com",
  projectId: "server-f5ca2",
  storageBucket: "server-f5ca2.appspot.com",
  messagingSenderId: "911418656641",
  appId: "1:911418656641:web:00d6d168eba14ebf984a80",
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let port, reader;
const outputDiv = document.getElementById('output');

function log(msg, type='info') {
    const d = new Date();
    const ts = d.toLocaleTimeString();
    let content = msg;
    if(type === 'data') content = `<span class="log-val">${msg}</span>`;
    if(type === 'error') content = `<span class="log-err">${msg}</span>`;
    outputDiv.innerHTML = `<div class="log-line"><span class="log-ts">[${ts}]</span>${content}</div>` + outputDiv.innerHTML;
}

async function connectMicrobit() {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    
    const btn = document.getElementById('connectBtn');
    btn.textContent = "Connected & Sending...";
    btn.disabled = true;
    btn.style.background = "#2E7D32";
    log("Serial port opened successfully.");

    reader = port.readable.getReader();
    let buffer = '';
    const textDecoder = new TextDecoder();

    while (true) {
      const { value, done } = await reader.read();
      if (done) { reader.releaseLock(); break; }
      if (!value) continue;

      buffer += textDecoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop(); 

      lines.forEach(processDataLine);
    }
  } catch (err) {
    console.error(err);
    log("Connection Failed: " + err.message, 'error');
  }
}

function processDataLine(line) {
    line = line.trim();
    if (!line) return;

    try {
        let arr = [];
        // ãƒ‡ãƒ¼ã‚¿å½¢å¼ã«åˆã‚ã›ã¦ãƒ‘ãƒ¼ã‚¹ (bytearray, JSON, CSVãªã©)
        if (line.startsWith("bytearray")) {
            const match = line.match(/bytearray\(b'(.*)'\)/);
            if (match) {
                let hexStr = match[1];
                arr = hexStr.split('\\x').filter(s=>s).map(s=>parseInt(s,16));
            }
        } else if (line.startsWith("[")) {
            arr = JSON.parse(line);
        } else {
            arr = line.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
        }

        // ãƒ‡ãƒ¼ã‚¿é•·è¶³ã‚Šãªã„ãªã‚‰å¼¾ã
        if (arr.length <= 1) return; 

        const now = new Date();
        const obj = { timestamp: now.getTime() };

        // å…ˆé ­(0ç•ªç›®)ã¯ä¸è¦ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã€1ç•ªç›®ã‹ã‚‰ room ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è©°ã‚ã‚‹
        // æœ€å¤§18éƒ¨å±‹ã¾ã§
        for (let i = 1; i < arr.length && i <= 18; i++) {
            obj["room" + i] = arr[i];
        }

        // æ—¥ä»˜ã‚­ãƒ¼ (YYYY-MM-DD)
        const y = now.getFullYear();
        const m = ('0' + (now.getMonth() + 1)).slice(-2);
        const d = ('0' + now.getDate()).slice(-2);
        const dateKey = `${y}-${m}-${d}`;

        // DBæ›´æ–°
        const updates = {};
        updates['rooms/latest'] = obj;
        
        // å±¥æ­´ã‚‚ä¿å­˜
        const newRef = database.ref().child('rooms/history/' + dateKey).push();
        updates['rooms/history/' + dateKey + '/' + newRef.key] = obj;

        database.ref().update(updates);
        
        // ç”»é¢ãƒ­ã‚°å‡ºåŠ›
        log(`Sent: [${arr.join(',')}] to ${dateKey}`, 'data');

    } catch (e) {
        // ãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã¯ç„¡è¦–
    }
}

document.getElementById("connectBtn").addEventListener("click", connectMicrobit);
</script>
</body>
</html>